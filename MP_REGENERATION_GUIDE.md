# MP自动回复系统说明文档

## 📋 功能概述

在冒险页面的战斗系统中，已实现角色魔法值(MP)的自动回复机制，让战斗更具策略性和持续性。

## ✨ 核心特性

### 1. 自动回复机制
- **回复频率**: 每2秒自动回复一次
- **回复数值**: 每次回复2-5点MP（随机值，保证平衡性）
- **回复上限**: MP不会超过角色当前等级对应的最大MP值
- **持续生效**: 从进入冒险页面开始，持续运行直到离开页面

### 2. 回复场景
✅ 战斗中持续回复
✅ 空闲状态持续回复
✅ 普通攻击后持续回复
✅ 技能攻击后持续回复
✅ 休息时持续回复

### 3. 视觉反馈

#### MP条动画效果
- **脉冲光晕**: MP条带有呼吸灯效果，每2秒一个周期
- **平滑过渡**: MP数值变化采用0.5秒缓动动画
- **颜色渐变**: 蓝色渐变条（#4facfe → #00f2fe）

#### 自动回复指示器
- **旋转图标**: MP标签旁显示旋转的 ↻ 符号
- **悬停提示**: 鼠标悬停显示"每2秒自动回复2-5点"
- **动态效果**: 3秒完整旋转一周，配合透明度变化

#### 战斗日志
- **智能显示**: 每3次回复仅显示1次日志，避免刷屏
- **绿色标记**: 回复日志使用heal类型，绿色边框高亮
- **格式示例**: `MP自动回复 +3`

## 🔧 技术实现

### 文件修改清单

#### 1. `/src/composables/useAdventure.ts`
- 新增 `mpRegenerationTimer` 定时器变量
- 新增 `startMpRegeneration()` 启动MP回复方法
- 新增 `stopMpRegeneration()` 停止MP回复方法
- 在初始化时自动启动MP回复
- 导出 `stopMpRegeneration` 供组件调用

```typescript
// MP自动回复核心逻辑
mpRegenerationTimer = window.setInterval(() => {
  if (currentMp.value < character.stats.mp) {
    const mpRegenAmount = Math.floor(2 + Math.random() * 4)
    const oldMp = currentMp.value
    currentMp.value = Math.min(character.stats.mp, currentMp.value + mpRegenAmount)
    
    const actualRegen = currentMp.value - oldMp
    if (actualRegen > 0 && Math.random() < 0.33) {
      addLog(`MP自动回复 +${actualRegen}`, 'heal')
    }
  }
}, 2000)
```

#### 2. `/src/views/AdventureView.vue`
- 在 `onUnmounted` 生命周期中调用 `stopMpRegeneration()`
- MP标签添加自动回复指示器 ↻
- 添加 `.mp-regen-indicator` 样式类
- 添加 `@keyframes mp-regen-spin` 旋转动画
- 添加 `@keyframes mp-pulse` 脉冲动画

## 📊 数值平衡

### MP回复速率
- **基础回复**: 2-5点/2秒 = 1-2.5点/秒
- **平均回复**: 3.5点/2秒 = 1.75点/秒
- **技能消耗**: 20点MP（技能攻击）

### 回复时间估算
假设角色MP从0恢复到满：
- **100 MP角色**: 约57-114秒（~1-2分钟）
- **150 MP角色**: 约86-171秒（~1.5-3分钟）

### 战斗平衡
- 技能消耗20 MP，需要约11-23秒自然回复
- 鼓励玩家混合使用普通攻击和技能
- 长期战斗能保持一定的技能使用频率

## 🎮 用户体验

### 优点
✅ **无需手动操作**: 自动后台回复，降低操作负担
✅ **视觉直观**: 动画效果让玩家清楚看到MP在回复
✅ **策略性增强**: 玩家需要权衡技能使用时机
✅ **持续战斗**: 支持长时间冒险而不用频繁休息

### 设计考虑
- **回复速度适中**: 既不会太快让MP无限使用，也不会太慢影响游戏节奏
- **随机波动**: 2-5点的随机值增加不可预测性
- **日志优化**: 减少刷屏，保持日志清晰可读
- **平滑动画**: 避免突兀的数值跳变

## 🛠️ 维护与扩展

### 调整回复速度
在 `useAdventure.ts` 中修改以下参数：

```typescript
// 修改回复间隔（毫秒）
}, 2000) // 改为 1000 则每1秒回复一次

// 修改回复数值范围
const mpRegenAmount = Math.floor(2 + Math.random() * 4) 
// 改为 Math.floor(5 + Math.random() * 6) 则每次回复5-10点
```

### 扩展功能建议
1. **装备加成**: 某些装备增加MP回复速度
2. **Buff系统**: 临时提升MP回复效果
3. **休息加速**: 休息状态MP回复速度翻倍
4. **战斗外增强**: 非战斗状态MP回复更快
5. **职业差异**: 法师职业MP回复速度更快

### 性能考虑
- 使用单一定时器，性能开销极小
- 组件卸载时正确清理定时器，无内存泄漏
- 数值变化采用CSS动画，GPU加速，流畅度高

## 🧪 测试建议

### 功能测试
1. ✅ 进入冒险页面后MP开始自动回复
2. ✅ 使用技能消耗MP后能正常回复
3. ✅ MP达到最大值后停止增长
4. ✅ 离开页面后定时器正确清理
5. ✅ 刷新页面后MP回复继续工作

### 视觉测试
1. ✅ MP条脉冲动画流畅
2. ✅ 回复指示器旋转正常
3. ✅ 战斗日志显示合理
4. ✅ 数值变化平滑过渡

## 📝 更新日志

### v1.0.0 (2025-10-24)
- ✅ 实现MP自动回复核心逻辑
- ✅ 添加视觉反馈效果
- ✅ 优化战斗日志显示
- ✅ 完善定时器清理机制

## 🎯 符合规范

### 角色属性成长规范
MP回复机制完全兼容现有的角色属性系统：
- ✅ 回复上限始终为 `character.stats.mp`
- ✅ 随着角色升级，MP上限提升，回复目标值自动调整
- ✅ 升级时MP自动回满，回复系统正常继续工作

### 数据持久化规范
- ✅ MP当前值通过 `currentMp` 响应式引用管理
- ✅ 组件卸载时保存角色最新数据到 localStorage
- ✅ 刷新页面后MP值正确恢复

---

**总结**: MP自动回复系统为战斗系统注入了持续性和策略性，通过合理的数值设计和流畅的视觉反馈，显著提升了游戏体验。系统架构清晰，易于维护和扩展。
